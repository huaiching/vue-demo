# 建立專案

## 1. vue init

透過 `CMD` 於 專案資料夾建立處，執行

```textile
yarn create vue
```

安裝相關選項選擇

```textile
  請選擇要包含的功能： (↑/↓ 切換，空格選擇，a 全選，enter 確認)
│  ◼ TypeScript
│  ◻ JSX 支援
│  ◼ Router（單頁應用程式開發）
│  ◼ Pinia（狀態管理）
│  ◻ Vitest（單元測試）
│  ◻ 端對端測試
│  ◻ ESLint（錯誤預防）
│  ◼ Prettier（程式碼格式化）
◆  請選擇要包含的試驗特性： (↑/↓ 切換，空格選擇，a 全選，enter 確認)
│  ◻ Oxlint
│  ◻ rolldown-vite（試驗性功能）
◆  跳過所有範例程式碼，建立一個空白的 Vue 專案？
│  ● Yes / ○ No
```

## 2. 安裝 依賴套件

進入 專案資料夾 透過 `CMD` 執行

```textile
yarn add element-plus dayjs taiwan-id-validator xlsx element-plus-table-dragable
yarn add -D @element-plus/icons-vue unplugin-auto-import unplugin-vue-components
```

- element-plus：UI 框架
- dayjs：日期處理
- taiwan-id-validator：台灣身分證/統一編號驗證
- xlsx：Excel 檔案處理（SheetJS）
- element-plus-table-dragable : 拖曳組件
- @element-plus/icons-vue：Element Plus 的圖示庫
- unplugin-auto-import + unplugin-vue-components：自動按需引入 Element Plus 組件與 API（推薦，減少 bundle 大小）

## 3. 設定 自動按需引入 Element Plus

開啟 根目錄的 `vite.config.ts` 調整 vue 的設定檔

- 自動按需引入 Element Plus
- 設定 port

```ts
import { fileURLToPath, URL } from 'node:url'

import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import AutoImport from 'unplugin-auto-import/vite'
import Components from 'unplugin-vue-components/vite'
import { ElementPlusResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  plugins: [
    vue(),
    AutoImport({
      resolvers: [ElementPlusResolver()],
    }),
    Components({
      resolvers: [ElementPlusResolver()],
    }),
  ],
  server: {
    port: 3000,
  },
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    },
  },
})
```

## 4. 設定 TypeScript 辨識 vue 檔案

於 `src` 新增檔案 `shims-vue.d.ts`

```ts
declare module '*.vue' {
  import type { DefineComponent } from 'vue'
  const component: DefineComponent<{}, {}, any>
  export default component
}
```

## 5. 新增 element plus 的 民國年日期套件

於 `src/common/Dayjs` 新增檔案 `MinguoDayjs.ts`

```ts
/**
 * 民國年支援套件（Vue 3 + Element Plus + Day.js）
 *
 * 主要特色：
 * 1. 輸入框顯示民國年格式：TTT/MM/DD → 114/12/27
 * 2. 手動輸入支援多種格式：114/12/27、1141227、1140101、14-01-01、140101 等
 * 3. 選擇器面板標頭顯示「114 年 12 月」
 * 4. 年份選擇面板顯示民國年：109 ~ 118
 * 5. v-model 綁定值仍為標準西元年字串（YYYY-MM-DD）
 */

import dayjs from 'dayjs'
import 'dayjs/locale/zh-tw'
import customParseFormat from 'dayjs/plugin/customParseFormat'
import { ElMessage } from 'element-plus'

const YEAR_BIAS = 1911  // 民國紀年與西元紀年的差值（1911）

// ========================================
// 1. 顯示插件：負責將 TTT 轉換為民國年顯示
// ========================================
const minguoEra = (option: any, dayjsClass: any) => {
  const prototype = dayjsClass.prototype
  const oldFormat = prototype.format  // 保存原始 format 方法

  // 覆寫 Day.js 的 format 方法
  prototype.format = function (formatStr: string) {
    // 將 format 中的 TTT 替換為實際民國年（三位補零）
    const result = formatStr.replace(/(\[[^\]]+\])|TTT/g, (match: string, bracket: string) => {
      if (bracket) return bracket  // 保留 [文字] 不變
      const minguoYear = this.$y - YEAR_BIAS  // this.$y 是 Day.js 內部儲存的西元年
      return String(minguoYear).padStart(3, '0')  // 補零至三位：114、015、005
    })
    // 其餘格式交給原始 format 處理
    return oldFormat.call(this, result)
  }
}

// ========================================
// 2. 解析插件：負責將使用者輸入的民國年轉換為 Day.js 可理解的西元年格式
//    支援：有分隔符、無分隔符、西元年輸入，並加入嚴格日期校驗
// ========================================
const minguoEraParse = (option: any, dayjsClass: any) => {
  const prototype = dayjsClass.prototype
  const oldParse = prototype.parse  // 保存原始 parse 方法

  prototype.parse = function (cfg: any) {
    let { date, args } = cfg

    // 基本驗證：無輸入或無格式時直接使用原生解析
    if (
      !date ||
      typeof date !== 'string' ||
      !args ||
      !args[1]
    ) {
      return oldParse.call(this, cfg)
    }

    const format: string = args[1].trim()

    // 只處理包含 TTT 的民國年格式，其他格式不干擾
    if (!format.includes('T')) {
      return oldParse.call(this, cfg)
    }

    let inputDate = date.trim()

    // ========================
    // Step 1: 處理各種輸入格式，統一轉為純數字字串（方便後續處理）
    // ========================
    let digitsOnly = inputDate.replace(/\D/g, '')  // 移除所有非數字

    // 年月格式補日為 01
    if (format === 'TTT/MM') {
      digitsOnly = digitsOnly + '01'
    }

    // 處理西元年輸入
    if (digitsOnly.length === 8) {
      const year = parseInt(digitsOnly.slice(0, 4), 10) - 1911
      const month = parseInt(digitsOnly.slice(4, 6), 10)
      const day = parseInt(digitsOnly.slice(6, 8), 10)
      digitsOnly = `${String(year).padStart(3, '0')}${String(month).padStart(2, '0')}${String(day).padStart(2, '0')}`
    }

    // ========================
    // Step 2: 處理無分隔符純數字輸入（台灣最常見用法）
    //    6碼：民國2位年（如 140101 → 民國14年）
    //    7碼：民國3位年（如 1140101 → 民國114年）
    // ========================
    if (digitsOnly.length === 6 || digitsOnly.length === 7) {
      let minguoYearStr: string
      let monthStr: string
      let dayStr: string = ''

      if (digitsOnly.length === 6) {
        // 6碼：年2碼 + 月2碼 + 日2碼
        minguoYearStr = digitsOnly.slice(0, 2).padStart(3, '0')  // "14" → "014"
        monthStr = digitsOnly.slice(2, 4)
        dayStr = digitsOnly.slice(4, 6)
      } else {
        // 7碼：年3碼 + 月2碼 + 日2碼
        minguoYearStr = digitsOnly.slice(0, 3)
        monthStr = digitsOnly.slice(3, 5)
        dayStr = digitsOnly.slice(5, 7)
      }

      // ========================
      // Step 3: 嚴格日期校驗（使用外部 isValidDate 工具）
      // ========================
      const fullMinguoDateStr = `${minguoYearStr.padStart(3, '0')}${monthStr.padStart(2, '0')}${dayStr.padStart(2, '0')}`

      if (isValidDate(fullMinguoDateStr)) {
        // 日期合法 → 轉換為西元年格式供 Day.js 解析
        const gregorianYear = parseInt(minguoYearStr, 10) + YEAR_BIAS

        let gregorianFormatted: string
        let newFormat: string

        if (format.includes('DD')) {
          gregorianFormatted = `${gregorianYear}/${monthStr.padStart(2, '0')}/${dayStr.padStart(2, '0')}`
          newFormat = 'YYYY/MM/DD'
        } else {
          gregorianFormatted = `${gregorianYear}/${monthStr.padStart(2, '0')}`
          newFormat = 'YYYY/MM'
        }

        return oldParse.call(this, {
          ...cfg,
          date: gregorianFormatted,
          args: [gregorianFormatted, newFormat],
        })
      } else {
        // 日期無效（如 114/01/50、114/02/30）
        // 顯示錯誤訊息
        ElMessage.error('日期格式錯誤，請檢查年月日是否正確')

        return null
      }
    }
  }
}

// ========================================
// 3. 覆寫 year() 方法：讓面板標頭與年份選擇器顯示民國年
// ========================================
const overrideYearMethod = () => {
  const originalYear = dayjs.prototype.year

  dayjs.prototype.year = function (setter?: number) {
    if (typeof setter === 'number') {
      // 設定年份時：傳入民國年 → 轉西元儲存
      return originalYear.call(this, setter + YEAR_BIAS)
    }
    // 取年份時：返回民國年
    return originalYear.call(this) - YEAR_BIAS
  }
}

/**
 * 檢查傳入的年月日是否為合法日期
 * @param date 純數字字串（民國7位 或 西元8位）
 * @returns boolean
 */
export const isValidDate = (date: string): boolean => {
  let year = 0
  let month = 0
  let day = 0

  if (date.length === 8) {
    // 西元年
    year = parseInt(date.slice(0, 4), 10)
    month = parseInt(date.slice(4, 6), 10)
    day = parseInt(date.slice(6, 8), 10)
  } else if (date.length === 7) {
    // 民國年
    year = parseInt(date.slice(0, 3), 10) + YEAR_BIAS
    month = parseInt(date.slice(3, 5), 10)
    day = parseInt(date.slice(5, 7), 10)
  } else {
    return false
  }

  if (month < 1 || month > 12) return false
  if (day < 1 || day > 31) return false

  // 使用 dayjs 精準檢查該月實際天數（考慮閏年）
  const maxDay = dayjs(`${year}-${month}`, 'YYYY-M').daysInMonth()
  return day <= maxDay
}

// ========================================
// 輔助函數：跳脫正則特殊字元（用於處理分隔符 /）
function escapeRegExp(str: string): string {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
}

// ========================================
// 初始化函數：專案啟動時呼叫
export function setupMinguoDayjs() {
  dayjs.locale('zh-tw')           // 設定繁體中文語系
  dayjs.extend(customParseFormat) // 啟用自訂格式解析

  // 套用插件
  dayjs.extend(minguoEra)         // 顯示民國年
  dayjs.extend(minguoEraParse)    // 解析民國年輸入

  // 讓面板顯示民國年
  overrideYearMethod()
}
```

## 6. 調整 main.ts

- 全局引入 Element Plus 的 CSS（全域）

- 全局引入 Element 黑暗模式

- 全局引入 dayjs

- 全局引入 Element Icon

- 全局設定 Element 日期套件 使用 民國年 (支援 不用輸入 `/`)

```ts
import { createApp } from 'vue'
import { createPinia } from 'pinia'

import App from './App.vue'
import router from './router'
import 'element-plus/dist/index.css'
import 'element-plus/theme-chalk/dark/css-vars.css'
import ElementPlus from 'element-plus'
import * as ElementPlusIconsVue from '@element-plus/icons-vue'
import dayjs from 'dayjs'
import zhTw from 'element-plus/es/locale/lang/zh-tw'
import { setupMinguoDayjs } from './common/Dayjs/MinguoDayjs'
setupMinguoDayjs()

const app = createApp(App)

for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
    app.component(key, component)
}

app.use(createPinia())
app.use(router)

app.use(ElementPlus, { locale: zhTw })

app.mount('#app')
app.config.globalProperties.$dayjs = dayjs
```

## 7. 建立 布局樣式

使用下述方式，建立 網站整體布局樣式

- 使用 Element Plus 的 `layout 布局` + `menu 組件`，來建立 左側邊欄。
- 使用 vue-router 來動態管理 連結設定，因此 router文件也要有對應的設定。
- 菜單收縮 + 黑暗布局開關

### 建立資料夾 `src/common/Menu`，並新增檔案 `MenuItem.vue`。

```html
<script setup>
import { computed } from 'vue'

const props = defineProps({
    route: {
        type: Object,
        required: true
    },
    basePath: {
        type: String,
        default: ''
    }
})

const fullPath = computed(() => {
    if (!props.basePath) return props.route.path
    return `${props.basePath}/${props.route.path}`.replace(/\/+/g, '/')
})

const hasChildren = computed(() => {
    return props.route.children && props.route.children.length > 0
})

const hasName = computed(() => {
    return props.route.name && props.route.name.toString().trim() !== ''
})
</script>

<template>
    <!-- 有 children 且有 name 才顯示子選單 -->
    <el-sub-menu v-if="hasChildren && hasName" :index="fullPath">
        <template #title>
            <el-icon>
                <component :is="route.meta?.icon" />
            </el-icon>
            <span>{{ route.name }}</span>
        </template>

        <MenuItem 
            v-for="child in route.children" 
            :key="child.path" 
            :route="child" 
            :base-path="fullPath" 
        />
    </el-sub-menu>

    <!-- 無 children 但有 name 才顯示選單項目 -->
    <el-menu-item v-else-if="!hasChildren && hasName" :index="fullPath">
        <el-icon>
            <component :is="route.meta?.icon" />
        </el-icon>
        <span>{{ route.name }}</span>
    </el-menu-item>

    <!-- 如果沒有 name，什麼都不渲染 -->
</template>
```

### 開啟 `src/App.vue`，將其修改為下面的程式

```html
<script setup>
import { RouterView, useRoute } from 'vue-router'
import { ref } from 'vue'
import router from './router'
import { Fold, Expand, Moon, Sunny } from '@element-plus/icons-vue'
import { useDark, useToggle } from '@vueuse/core'
import MenuItem from './common/Menu/MenuItem.vue'


const route = useRoute()

// 側邊欄收起狀態
const isCollapse = ref(false)

// 可顯示的 routes
const routesList = router.options.routes

// 黑暗模式切換（使用 VueUse）
const isDark = useDark({
  valueDark: 'dark',
  valueLight: 'light',
  storageKey: 'vue-notes-theme',  // 儲存到 localStorage，保持偏好
})
const toggleDark = useToggle(isDark)
</script>

<template>
  <div class="common-layout">
    <el-container>
      <!-- Header --><el-header>
        <div class="header-content">
          <!-- 左側：標題 + 收合按鈕 -->
          <div class="header-left">
            <h1 class="title">Vue 學習筆記</h1>

            <!-- 縮放按鈕（在標題右邊） -->
            <el-button text @click="isCollapse = !isCollapse">
              <el-icon>
                <component :is="isCollapse ? Expand : Fold" />
              </el-icon>
            </el-button>
          </div>

          <!-- 右側：黑暗模式切換按鈕（最右側） -->
          <div class="header-right">
            <el-button text @click="toggleDark()">
              <el-icon>
                <component :is="isDark ? Sunny : Moon" />
              </el-icon>
            </el-button>
          </div>
        </div>
      </el-header>

      <el-container>
        <!-- Side Menu -->
        <el-aside :width="isCollapse ? '64px' : '300px'">
          <el-menu router :collapse="isCollapse" :default-active="route.path" :collapse-transition="true">
            <MenuItem v-for="route in routesList" :key="route.path" :route="route" />
          </el-menu>
        </el-aside>

        <!-- Main -->
        <el-main>
          <RouterView />
        </el-main>
      </el-container>
    </el-container>
  </div>
</template>

<style scoped>
.common-layout {
  height: 100vh;
}

/* Header */
.el-header {
  color: #409eff;
  display: flex;
  align-items: center;
}

.header-content {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between; /* 左右兩端對齊 */
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.title {
  margin: 0;
  font-size: 24px;
}

.header-right {
  margin-left: auto; /* 確保在 flex 容器中推到最右 */
}

.el-aside {
  transition: width 0.3s ease;
}

.el-menu {
  height: 100%;
  border-right: none;
}
</style>
```

## 8. 設定 範例頁面

建立資料夾 `src/pages/Home`，並新增檔案 `index.vue`。

複製貼上 下面的內容

```html
<template>
    首頁
</template>
```

建立資料夾 `src/pages/Demo`，並新增檔案 `index.vue`。

複製貼上 下面的內容

```html
<template>
    測試頁面
</template>
```

## 9. 設定 菜單文件 (router)

開啟 `src/router/index.ts`，並將內容 調整為

```ts
import { createRouter, createWebHistory } from 'vue-router'

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    {
      path: '/',
      redirect: '/home',
    },
    {
      path: "/home",
      name: "首頁",
      component: () => import('@/pages/Home/index.vue'),
      meta: { icon: 'House' }
    },
    {
      path: "/demo",
      name: "測試",
      meta: { icon: 'Location' },
      children: [
        {
          path: "page",
          name: "測試頁面",
          component: () => import('@/pages/Demo/index.vue')
        },
      ]
    },
  ],
})

export default router
```

## 10. 調整 網站標題

開啟 根目錄 的 `index.html`，於 `head` 的 `title` 可以設定 網站標題。

## 11. 啟動專案

於 `CMD` 執行

```textile
yarn dev
```

訪問 http://localhost:3000/ 即可開啟網站
